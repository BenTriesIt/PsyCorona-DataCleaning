---
title: "Psycorona - Data Cleaning Documentation"
subtitle: "Step by step description" 
author: "PsyCorona Gang"
date: "3/30/2020"
output:
  html_document: 
    code_folding: hide
    mathjax: default
    theme: yeti
    toc: yes
    toc_float: yes
editor_options:
  chunk_output_type: console
---


<style type="text/css">
.main-container {
  max-width: 1300px;
  margin-left: auto;
  margin-right: auto;
}
.table {
  margin-left:auto; 
  margin-right:auto;
}
</style>


```{r setup, include=FALSE}
# R Studio Clean-Up
  cat("\014") # clear console
  rm(list=ls()) # clear workspace
  gc # garbage collector
  
# Install and Load Packages
  #if(!require(pacman)) install.packages("pacman")
  # require(pacman)
  # pacman::p_load(psych, ggplot2, ggthemes, haven, data.table, dplyr, tidyr, Hmisc, mada, 
  #                knitr, kableExtra, naniar, stats, readxl, matrixStats, ISOcodes, pander,
  #                Scale)
lib <- c("psych", "ggplot2", "ggthemes", "haven", "data.table", "dplyr", "tidyr", "Hmisc", "mada", 
         "knitr", "kableExtra", "naniar", "stats", "readxl", "matrixStats", "ISOcodes", "pander", "Scale")

invisible(lapply(lib, library, character.only = TRUE))  
lapply(lib, library, character.only = TRUE)
  
# Load Custom Packages  
  source("./scripts/functions/fun.panel.R")
  source("./scripts/functions/themes.R")
  source("./scripts/functions/dictionary_functions.R")
  
# Markdown Options
  knitr::opts_knit$set(root.dir = rprojroot::find_rstudio_root_file()) # set working directory
  knitr::opts_knit$get("root.dir") # check working directory
  options(scipen = 999, digits = 4, width = 400) #removes scientific quotation
  #knitr::opts_chunk$set(echo = TRUE, cache = F, cache.path = rprojroot::find_rstudio_root_file('cache/')) # cache settings
  knitr::knit_hooks$set(
   error = function(x, options) {
     paste('\n\n<div class="alert alert-danger">',
           gsub('##', '\n', gsub('^##\ Error', '**Error**', x)),
           '</div>', sep = '\n')
   },
   warning = function(x, options) {
     paste('\n\n<div class="alert alert-warning">',
           gsub('##', '\n', gsub('^##\ Warning:', '**Warning**', x)),
           '</div>', sep = '\n')
   },
   message = function(x, options) {
     paste('\n\n<div class="alert alert-info">',
           gsub('##', '\n', x),
           '</div>', sep = '\n')
   }
  )
  htmltools::tagList(rmarkdown::html_dependency_font_awesome())

# Global Chunk Options
  knitr::opts_chunk$set(echo = TRUE)
```

Note. Boxplots display the interquartile range (IQR, center box), and the whiskers extend 1.5*IQR from the lower and upper hinge. The white point indicates the mean and the white center line indicates the median.   

<br/>

## **Import Data**
In a first step we import the raw Qualtrics data, which was downloaded as an SPSS file.   

```{r LoadRaw, echo=T, warning=F, message=F}
# Reset working directory to folder current file is saved in
#setwd(dirname(rstudioapi::getActiveDocumentContext()$path))

# Import Qualtrics Survey Data
dt0Raw <- read_spss("data/raw data/Snowball+Corona+Long-Term+Coverage+-+Baseline_April+1,+2020_07.26.sav")
```

The raw data set includes `r length(dt0Raw)` variables for `r nrow(dt0Raw)` cases.   


## **Data Quality**   

### Filter: Preview Responses
Filter the Preview responses.
```{r preview, echo=T, warning=F, message=F}
# flag Preview Responses
dt1Preview <- dt0Raw %>%
  mutate(FilterPreview = labelled(ifelse(Status == 0,0,1),
                                  labels = c(preview = 1), label="Filter: survey preview response"))
```


### Filter: Survey Progress (drop out)  
<!-- https://cran.r-project.org/web/packages/naniar/vignettes/naniar-visualisation.html -->

Inspecting missing data in the items.

```{r Missing, echo=T, warning=F, message=F}
# Table: Missing Data per item
dt1Preview %>%
  dplyr::select(-starts_with("t_"), -starts_with("Pol")) %>% #drop timers and Political orientation (because of translation missingness)
  dplyr::select_if(~sum(is.na(.)) > 0) %>% # remove all variables that have no missingess
  naniar::miss_var_summary(.) %>% # by variable summary of missingness proportion
  DT::datatable(.,
                colnames = c("Variable", "Number Missing", "Percentage Missing"),
                filter = 'top',
                extensions = 'Buttons',
                options = list(
                  columnDefs = list(list(className = 'dt-center')),
                  #autoWidth = TRUE,
                  dom = 'Bfrtlip',
                  buttons = c('copy', 'csv', 'excel', 'pdf', 'print'))) %>%
  DT::formatRound('pct_miss', digits = 2)
  
# Plot: Missing Data per item
dt1Preview %>%
  dplyr::select(-starts_with("t_"), -starts_with("Pol")) %>% #drop timers and Political orientation (because of translation missingness)
  dplyr::select_if(~sum(is.na(.)) > 0) %>% # remove all variables that have no missingess
  naniar::gg_miss_var(.) # visualize by variable summary of missingness proportion

# Plot: Missing Data cumulative
dt1Preview %>%
  dplyr::select(-starts_with("t_"), -starts_with("Pol")) %>% #drop timers and Political orientation (because of translation missingness)
  dplyr::select_if(~sum(is.na(.)) > 0) %>% # remove all variables that have no missingess
  naniar::gg_miss_var_cumsum(.) # missingness development over survey

# Co-occurences of missingess - too many variables
#dt0Raw %>%
#  dplyr::select(-starts_with("t_"), -starts_with("Pol")) %>% #drop timers and Political orientation (because of translation missingness)
#  dplyr::select_if(~sum(is.na(.)) > 0) %>% # remove all variables that have no missingess
#  naniar::gg_miss_upset(., nsets = n_var_miss(.)) # visualize missingess co-occurences

# set time cut-off criterion:
progressCutOff <- 97 #cut-off criterion in percent
progressFilter <- dt1Preview %>%
  dplyr::select(Progress) %>%
  mutate(out = Progress < progressCutOff)

progressCutOffPerc <- round(sum(progressFilter$out)/nrow(progressFilter)*100,2) # percent of missing data with current cut-off criterion

# plot histogram and missing
ggplot(data=progressFilter, aes(x=Progress, fill=out)) +
  geom_histogram(bins=50,
                 alpha=.6) +
  geom_vline(xintercept = progressCutOff, 
             color = "darkred",
             linetype = "longdash") +
  geom_text(aes(x=progressCutOff, label=paste0("Progress cut-off: ",progressCutOff,"%\n"), y=Inf), 
            hjust = 1,
            colour="darkred", 
            angle=90) +
  geom_text(aes(x=progressCutOff, label=paste0("\ndata loss: ",progressCutOffPerc,"%"), y=Inf), 
            hjust = 1,
            colour="darkred", 
            angle=90) +
  #scale_x_continuous(breaks = seq(0, 100,3)) +
  scale_fill_manual(values=c("darkgrey","darkred")) +
  labs(title = "Histogram: Survey Progress", 
       x = "Survey Progress [Percent completed]",
       y = "Frequency Count") +
  theme_Publication() +
  theme(legend.position = "none")

# flag anyone with less than 5 minutes survey duration
dt2Progress <- dt1Preview %>%
  mutate(FilterProgress = labelled(ifelse(Progress < progressCutOff,1,0),
                               labels = c(`consent` = 1), label="Filter: Did not see debriefing"))

rm(progressFilter, progressCutOff, progressCutOffPerc)
```


### Filter: Short Duration on Survey   
Filter survey responses that were shorter than 5 minutes.   
```{r Duration, echo=T, warning=F, message=F}
# truncate data:
tOutlierHigh <- dt2Progress %>%
  dplyr::select(Duration__in_seconds_) %>%
  filter(Duration__in_seconds_<=stats::median(Duration__in_seconds_)+stats::mad(Duration__in_seconds_)*3.5) %>%
  mutate(Minutes = Duration__in_seconds_/60)

# set time cut-off criterion:
tCutOff <- 5 #cut-off criterion in minutes
# CJ: This might be a bit strict, I suspect that I completed it in <10 minutes. 
tCutOffPerc <- round(sum(tOutlierHigh$Minutes<tCutOff)/nrow(dt2Progress)*100,2) # percent of missing data with current cut-off criterion
tOutlierHigh$out <- tOutlierHigh$Minutes < tCutOff

# plot histogram and missing
ggplot(data=tOutlierHigh, aes(x=Minutes, fill=out)) +
  geom_histogram(bins=round(max(tOutlierHigh$Minutes),0),
                 alpha=.6) +
  geom_vline(xintercept = tCutOff, 
             color = "darkred",
             linetype = "longdash") +
  geom_text(aes(x=tCutOff, label=paste0("time cut-off: ",tCutOff," Minutes\n"), y=Inf), 
            hjust = 1,
            colour="darkred", 
            angle=90) +
  geom_text(aes(x=tCutOff, label=paste0("\ndata loss: ",tCutOffPerc,"%"), y=Inf), 
            hjust = 1,
            colour="darkred", 
            angle=90) +
  scale_x_continuous(breaks = seq(0, round(max(tOutlierHigh$Minutes),0), 5)) +
  scale_fill_manual(values=c("darkgrey","darkred")) +
  labs(title = "Truncated Histogram: Survey Duration", 
       x = "Duration [Mintues]",
       y = "Frequency Count",
       caption = "Notes:
       (1) Truncated: all participants who took less time than Median+3.5*MAD
       (2) Each bin represents one Minute") +
  theme_Publication() +
  theme(legend.position = "none")

# flag anyone with less than 5 minutes survey duration
dt3Time <- dt2Progress %>%
  mutate(FilterTime = labelled(ifelse(Duration__in_seconds_ > tCutOff*60,0,1),
                               labels = c(`extremely quick` = 1), label="Filter: Took less than 5 minutes on survey"))


rm(tOutlierHigh, tCutOff, tCutOffPerc)
# flag anyone with less than 5 minutes survey duration
dt2Time <- dt1Preview %>%
  mutate(FilterTime = labelled(ifelse(Duration__in_seconds_ > 300,0,1),
                               labels = c(`extremely quick` = 1), label="Filter: Took less than 5 minutes on survey"))
```


### Filter: Straightliners   
Filter participants, who have straightlined on the job insecurity scale, which includes a reverse coded item. We only flag people who straightlined outside the median categories because all "neither agree nor disagree" might be meaningful response.   
```{r Straightliner, echo=T, warning=F, message=F}
# CheckMissingness pattern
naniar::gg_miss_upset(dt3Time %>%
  dplyr::select(ResponseId, jbInsec01, jbInsec02, jbInsec03) %>%
  na_if(., -99) # all -99 into <NA>
)

# isolate respondents who have straightlined outside a the median categories (b/c all "neither agree nor disagree" might be meaningful response) 
jobinsecRed <- dt3Time %>%
  dplyr::select(ResponseId, jbInsec01, jbInsec02, jbInsec03) %>%
  na_if(., -99) %>% # all -99 into <NA>
  na.omit() %>% # remove people who have missing data on one of the three items
  mutate(mean = rowMeans(dplyr::select(., c("jbInsec01", "jbInsec02", "jbInsec03"))), 
         sd = matrixStats::rowSds(as.matrix(dplyr::select(., c("jbInsec01", "jbInsec02", "jbInsec03"))))) %>% # calculate row-means and row-sds 
  filter(sd == 0, mean != 0)

# flag anyone who straightlined on job insecurity
dt4Straightliner <- dt3Time %>%
  mutate(FilterStraightliner = labelled(ifelse(!ResponseId %in% jobinsecRed$ResponseId,0,1),
                                        labels = c(straightliner = 1), label="Filter: straightliner on Job Insecurity"))
rm(jobinsecRed)
```


## **Data Preparation**   
Note: For each of the scales we do an item analysis, and combine the items to the mean- (.m), and factor scores (.fa). We also centered (.c) and standardized (.z) the mean scores. Most of these items are not labelled for SPSS yet.  

### Recoded Items   
Re-coding reverse coded items and the Qualtrics language codes.
```{r recode, echo=T, warning=F, message=F}
# Recoded Items
dt5newVars <- dt4Straightliner %>%
  mutate(jbInsec02_R = labelled(recode(as.numeric(jbInsec02), `-2` = 2, `-1` = 1, `0` = 0, `1` = -1, `2` = -2, `-99` = -99),
                                labels = NULL, label="Job Insecurity 02 (re-coded)"),
         bor03_R = labelled(recode(as.numeric(bor03), `-2` = 2, `-1` = 1, `0` = 0, `1` = -1, `2` = -2),
                            labels = NULL, label="Boredom 03 (re-coded)"))
# Language
# Import Qualtrics Language Codes
qualtricsLanguage <- read_excel("data/raw data/qualtricsLanguageCodes.xlsx")
dt5newVars <- merge(x=dt5newVars, y=qualtricsLanguage, by="Q_Language", all.x=TRUE)
rm(qualtricsLanguage)
```

### Country
We currently have `r length(table(dt5newVars$country))` different free text country responses. Here we aim to consolidate them into one variable.
```{r Country, echo=T, warning=F, message=F}
# CJ: Just as a benchmark, geolocate IP address. Can always use this if a free 
# CJ: text country response does not resolve.
library(rgeolocate)
file <- system.file("extdata","GeoLite2-Country.mmdb", package = "rgeolocate")
geolocations <- maxmind(dt5newVars$IPAddress, file, c("continent_name", "country_code", "country_name"))
dt5newVars$coded_country_ip <- geolocations$country_name

# CJ: This is a slightly cleaner, faster, and more informative regex based approach.
# CJ: The function and dictionary (based on the code below, some errors corrected) 
# CJ: is in source("./scripts/functions/dictionary_functions.R")
country_matches <- cat_words(tolower(dt5newVars$country), country_dict)
# Check duplicates, and which regular expressions triggered them
invisible(country_matches$dup)
# Check unmatched strings, fix common ones
invisible(head(country_matches$unmatched))
dt5newVars$coded_country_cj <- country_matches$words

#code originally provided by Courtney Soderberg

dt5newVars <- dt5newVars %>%
  mutate(coded_country = case_when(grepl('^usa$', country, ignore.case = T) | grepl('unites state', country, ignore.case = T) | 
                                     grepl('united state', country, ignore.case = T) | grepl('^america$', country, ignore.case = T) |
                                     grepl('U\\.S\\.', country, ignore.case = T) | grepl('Estados Unidos', country, ignore.case = T) |
                                     grepl('colorado', country, ignore.case = T) | grepl('^us$', country, ignore.case = T) |
                                     grepl('xas', country, ignore.case = T) | grepl('sates', country, ignore.case = T) |
                                     grepl('Amerika Serikat', country, ignore.case = T) | grepl('california', country, ignore.case = T) |
                                     grepl('corlifornia', country, ignore.case = T) | grepl('états-unis', country, ignore.case = T) |
                                     grepl('york', country, ignore.case = T) | grepl('yark', country, ignore.case = T) |
                                     grepl('puerto rico', country, ignore.case = T) | grepl('^tx$', country, ignore.case = T) |
                                     grepl('^tn$', country, ignore.case = T) | grepl('U S', country, ignore.case = T) ~ 'United States of America',
                                   grepl('canad', country, ignore.case = T) | grepl('vancouver', country, ignore.case = T) ~ 'Canada',
                                   grepl('mexico', country, ignore.case = T) | grepl('México', country, ignore.case = T) ~ 'Mexico',
                                   grepl('spain', country, ignore.case = T) | grepl('esp', country, ignore.case = T) |
                                     grepl('Spagna', country, ignore.case = T) | grepl('Spanien', country, ignore.case = T) |
                                     grepl('Catal', country, ignore.case = T) | grepl('Euskal Herria', country, ignore.case = T) |
                                     grepl('basque', country, ignore.case = T) | grepl('Eapaña', country, ignore.case = T) |
                                     grepl('Esapaña', country, ignore.case = T) | grepl('madrid', country, ignore.case = T) |
                                     grepl('Montalbán de Córdoba', country, ignore.case = T) | grepl('Pais vasco', country, ignore.case = T) |
                                     grepl('Spanje', country, ignore.case = T) ~ 'Spain',
                                   grepl('france', country, ignore.case = T) | grepl('Francia', country, ignore.case = T) |
                                     grepl('Frankrijk', country, ignore.case = T) ~ 'France',
                                   grepl('germany', country, ignore.case = T) | grepl('deutschland', country, ignore.case = T) | 
                                     grepl('Alemania', country, ignore.case = T) | grepl('germania', country, ignore.case = T) |
                                     grepl('^Almanya$', country, ignore.case = T) | grepl('berlin', country, ignore.case = T) |
                                     grepl('Duitsland', country, ignore.case = T) ~ 'Germany',
                                   grepl('portugal', country, ignore.case = T) ~ 'Portugal',
                                   grepl('weden', country, ignore.case = T) ~ 'Sweden',
                                   grepl('netherland', country, ignore.case = T) | grepl('nederland', country, ignore.case = T) | 
                                     grepl('Niederlande', country, ignore.case = T) | grepl('Belanda', country, ignore.case = T) |
                                     grepl('^NL$', country, ignore.case = T) | grepl('Olanda', country, ignore.case = T) |
                                     grepl('Paesi Bassi', country, ignore.case = T) | grepl('bajos', country, ignore.case = T) |
                                     grepl('Gelderland', country, ignore.case = T) | grepl('Hollanda', country, ignore.case = T) ~ 'Netherlands',
                                   grepl('^indonesia$', country, ignore.case = T) | grepl('indonesian', country, ignore.case = T) | 
                                     grepl('kota Tarakan', country, ignore.case = T) | grepl('Imdonesia', country, ignore.case = T) |
                                     grepl('Indònesia', country, ignore.case = T) | grepl('jakarta', country, ignore.case = T) ~ 'Indonesia',
                                   grepl('ital', country, ignore.case = T) | grepl('Sardegna', country, ignore.case = T) | 
                                     grepl('Bisceglie', country, ignore.case = T) | grepl('Ladispoli', country, ignore.case = T) |
                                     grepl('Castelforte', country, ignore.case = T) | grepl('milano', country, ignore.case = T) |
                                     (grepl('roma', country, ignore.case = T) & !grepl('romania', country, ignore.case = T)) |
                                     grepl('Dorgali', country, ignore.case = T) | grepl('bari', country, ignore.case = T) |
                                     grepl('bologna', country, ignore.case = T) | grepl('Brescia', country, ignore.case = T) |
                                     grepl('Cala gonone', country, ignore.case = T) | grepl('Chieti', country, ignore.case = T) |
                                     grepl('Ferentino', country, ignore.case = T) | grepl('Frosinone', country, ignore.case = T) |
                                     grepl('Gragnano lucca	', country, ignore.case = T) | grepl('Guidonia', country, ignore.case = T) |
                                     grepl('Itaia', country, ignore.case = T) | grepl('İtalya', country, ignore.case = T) |
                                     grepl('Mareno di Piave', country, ignore.case = T) | grepl('modena', country, ignore.case = T) |
                                     grepl('Pellizzano', country, ignore.case = T) | grepl('Predazzo', country, ignore.case = T) |
                                     grepl('Refrontolo', country, ignore.case = T) | grepl('Cosma e Damiano', country, ignore.case = T) |
                                     grepl('Scalea', country, ignore.case = T) | grepl('Scauri', country, ignore.case = T) |
                                     grepl('Segni', country, ignore.case = T) | grepl('SETTIMO VITTONE', country, ignore.case = T) |
                                     grepl('Susegana', country, ignore.case = T) | grepl('Terralba', country, ignore.case = T) |
                                     grepl('trento', country, ignore.case = T) | grepl('treviso', country, ignore.case = T) |
                                     grepl('Tezze di Piave', country, ignore.case = T) | grepl('Valmontone', country, ignore.case = T) |
                                     grepl('Vergato', country, ignore.case = T) | grepl('veneto', country, ignore.case = T) |
                                     grepl('Gragnano lucca', country, ignore.case = T) ~ 'Italy',
                                   grepl('hong kong', country, ignore.case = T) ~ 'Hong Kong S.A.R.',
                                   grepl('phil', country, ignore.case = T) | grepl('Filipinas', country, ignore.case = T) ~ 'Philippines',
                                   grepl('argentina', country, ignore.case = T) | grepl('arge', country, ignore.case = T) ~ 'Argentina',
                                   grepl('pakistan', country, ignore.case = T) | grepl('Abbottabad', country, ignore.case = T) |
                                     grepl('Peshawar', country, ignore.case = T) ~ 'Pakistan',
                                   grepl('united kingdo', country, ignore.case = T) | grepl('^uk$', country, ignore.case = T) |
                                     grepl('Reino Unido', country, ignore.case = T) | grepl('britain', country, ignore.case = T) |
                                     grepl('Regno Unito', country, ignore.case = T) | grepl('u\\.k\\.', country, ignore.case = T) |
                                     grepl('بريطانيا', country, ignore.case = T) | grepl('the uk', country, ignore.case = T) |
                                     grepl('U K', country, ignore.case = T) | grepl('Verenigd Koninkrijk', country, ignore.case = T) |
                                     grepl('Windsor', country, ignore.case = T) | grepl('scotland', country, ignore.case = T) |
                                     grepl('england', country, ignore.case = T) | grepl('wales', country, ignore.case = T) |
                                     grepl('İngiltere', country, ignore.case = T) | grepl('Northern Ireland', country, ignore.case = T) |
                                     grepl('Egland', country, ignore.case = T) | grepl('^gb$', country, ignore.case = T) |
                                     grepl('N Ireland', country, ignore.case = T) | grepl('Schotland', country, ignore.case = T) |
                                     grepl('Scozia', country, ignore.case = T) ~ 'United Kingdom',
                                   grepl('africa', country, ignore.case = T) | grepl('^SA$', country, ignore.case = T) |
                                     grepl('Sudáfrica', country, ignore.case = T) | grepl('western cape', country, ignore.case = T) ~ 'South Africa',
                                   grepl('^chile$', country, ignore.case = T) ~ 'Chile',
                                   grepl('australia', country, ignore.case = T) | grepl('Austrija', country, ignore.case = T) ~ 'Australia',
                                   grepl('colombia', country, ignore.case = T) ~ 'Colombia',
                                   grepl('turkey', country, ignore.case = T) | grepl('tür', country, ignore.case = T) ~ 'Turkey',
                                   grepl('taiwan', country, ignore.case = T) ~ 'Taiwan',
                                   grepl('^Venezuela$', country, ignore.case = T) ~ 'Venezuela',
                                   grepl('israel', country, ignore.case = T) | grepl('اللد', country, ignore.case = T) |
                                     grepl('اسرائيل', country, ignore.case = T) | grepl('كفر قاسم', country, ignore.case = T) |
                                     grepl('Isreal', country, ignore.case = T) | grepl('רמלה', country, ignore.case = T) ~ 'Israel',
                                   grepl('greece', country, ignore.case = T) | grepl('Grecia', country, ignore.case = T) ~ 'Greece',
                                   grepl('austria', country, ignore.case = T) | grepl('sterreich', country, ignore.case = T) ~ 'Austria',
                                   grepl('new zealand', country, ignore.case = T) | grepl('Neuseeland', country, ignore.case = T) ~ 'New Zealand',
                                   grepl('Tuni', country, ignore.case = T) | grepl('تونس', country, ignore.case = T) ~ 'Tunisia',
                                   grepl('Belg', country, ignore.case = T) | grepl('Bélgica', country, ignore.case = T) ~ 'Belgium',
                                   grepl('China', country, ignore.case = T) ~ 'China',
                                   grepl('cyp', country, ignore.case = T) ~ 'Cyprus',
                                   grepl('Schweiz', country, ignore.case = T) | grepl('Suiza', country, ignore.case = T) |
                                     grepl('Svizzera', country, ignore.case = T) | grepl('Zwitserland', country, ignore.case = T) |
                                     grepl('switzerland', country, ignore.case = T) ~ 'Switzerland',
                                   grepl('United Arab Emirates', country, ignore.case = T) | grepl('uae', country, ignore.case = T) ~ 'United Arab Emirates',
                                   grepl('Croa', country, ignore.case = T) ~ 'Croatia',
                                   grepl('india', country, ignore.case = T) ~ 'India',
                                   grepl('algeri', country, ignore.case = T) | grepl('الجزائر', country, ignore.case = T) |
                                     grepl('Algérie', country, ignore.case = T) ~ 'Algeria',
                                   grepl('bulgaria', country, ignore.case = T) ~ 'Bulgaria',
                                   grepl('Poland', country, ignore.case = T) | grepl('POLONIA', country, ignore.case = T) ~ 'Poland',
                                   grepl('romania', country, ignore.case = T) ~ 'Romania',
                                   grepl('singapore', country, ignore.case = T) ~ 'Singapore',
                                   grepl('Srbija', country, ignore.case = T) | grepl('serbia', country, ignore.case = T) |
                                     grepl('Србија', country, ignore.case = T) ~ 'Republic of Serbia',
                                   grepl('czech', country, ignore.case = T) | grepl('checa', country, ignore.case = T) ~ 'Czech Republic',
                                   grepl('lux', country, ignore.case = T) ~ 'Luxembourg',
                                   grepl('slova', country, ignore.case = T) ~ 'Slovakia',
                                   grepl('brazil', country, ignore.case = T) | grepl('brasil', country, ignore.case = T)~ 'Brazil',
                                   grepl('^ireland$', country, ignore.case = T) | grepl('Irlanda', country, ignore.case = T) ~ 'Ireland',
                                   grepl('japan', country, ignore.case = T) | grepl('Giappone', country, ignore.case = T) |
                                     grepl('Japonya', country, ignore.case = T) ~ 'Japan',
                                   grepl('Malay', country, ignore.case = T) ~ 'Malaysia',
                                   grepl('nigeria', country, ignore.case = T) ~ 'Nigeria',
                                   grepl('Riyad', country, ignore.case = T) | grepl('^Saudi arabia$', country, ignore.case = T) |
                                     grepl('Arabia Saudita', country, ignore.case = T) | grepl('^saudi$', country, ignore.case = T) |
                                     grepl('Kingdom of Saudia arabia', country, ignore.case = T) | grepl('KSA', country, ignore.case = T) |
                                     grepl('k\\.s\\.a', country, ignore.case = T) | grepl('Arabie saoudite', country, ignore.case = T) | 
                                     grepl('الرياض', country, ignore.case = T) | grepl('السعودية', country, ignore.case = T) |
                                     grepl('السعوديه', country, ignore.case = T) ~ 'Saudi Arabia',
                                   grepl('^thailand$', country, ignore.case = T) ~ 'Thailand',
                                   grepl('urug', country, ignore.case = T) ~ 'Uruguay',
                                   grepl('costa', country, ignore.case = T) ~ 'Costa Rica', 
                                   grepl('ecuador', country, ignore.case = T) ~ 'Ecuador',
                                   grepl('finland', country, ignore.case = T) ~ 'Finland', 
                                   grepl('guat', country, ignore.case = T) ~ 'Guatemala',
                                   grepl('iceland', country, ignore.case = T) ~ 'Iceland',
                                   grepl('iraq', country, ignore.case = T) | grepl('العراق', country, ignore.case = T) ~ 'Iraq',
                                   grepl('iran', country, ignore.case = T) ~ 'Iran',
                                   grepl('lebanon', country, ignore.case = T) | grepl('liban', country, ignore.case = T) ~ 'Lebanon',
                                   grepl('norway', country, ignore.case = T) ~ 'Norway',
                                   grepl('palestine', country, ignore.case = T) | grepl('فلسطين	', country, ignore.case = T) |
                                     grepl('^فلسطين$', country, ignore.case = T) | grepl('الرملة', country, ignore.case = T) ~ 'Palestine',
                                   grepl('peru', country, ignore.case = T) ~ 'Peru',
                                   grepl('domin', country, ignore.case = T) ~ 'Dominican Republic',
                                   grepl('albania', country, ignore.case = T) ~ 'Albania',
                                   grepl('andorra', country, ignore.case = T) ~ 'Andorra',
                                   grepl('bahrain', country, ignore.case = T) ~ 'Bahrain',
                                   grepl('bangladesh', country, ignore.case = T) ~ 'Bangladesh',
                                   grepl('botswana', country, ignore.case = T) ~ 'Botswana',
                                   grepl('camer', country, ignore.case = T) ~ 'Cameroon',
                                   grepl('المغرب', country, ignore.case = T) | grepl('Maroc', country, ignore.case = T) ~ 'Morocco',
                                   grepl('jordan', country, ignore.case = T) ~ 'Jordan',
                                   grepl('ليبيا', country, ignore.case = T) ~ 'Libya',
                                   grepl('مصر', country, ignore.case = T) ~ 'Egypt',
                                   grepl('mark', country, ignore.case = T) ~ 'Denmark',
                                   grepl('salvador', country, ignore.case = T) ~ 'El Salvador',
                                   grepl('estonia', country, ignore.case = T) ~ 'Estonia',
                                   grepl('korea', country, ignore.case = T) | grepl('Güney Kore', country, ignore.case = T) ~ 'South Korea',
                                   grepl('hungary', country, ignore.case = T) ~ 'Hungary',
                                   grepl('maurice', country, ignore.case = T) ~ 'Mauritius',
                                   grepl('jamaica', country, ignore.case = T) ~ 'Jamaica',
                                   grepl('kenia', country, ignore.case = T) ~ 'Kenya',
                                   grepl('laos', country, ignore.case = T) ~ 'Laos',
                                   grepl('latvia', country, ignore.case = T) ~ 'Latvia',
                                   grepl('malta', country, ignore.case = T) ~ 'Malta',
                                   grepl('myanmar', country, ignore.case = T) ~ 'Myanmar',
                                   grepl('nepal', country, ignore.case = T) ~ 'Nepal',
                                   grepl('^oman$', country, ignore.case = T) ~ 'Oman',
                                   grepl('qatar', country, ignore.case = T) ~ 'Qatar',
                                   grepl('panam', country, ignore.case = T) ~ 'Panama',
                                   grepl('tanzania', country, ignore.case = T) ~ 'United Republic of Tanzania',
                                   grepl('vietnam', country, ignore.case = T) ~ 'Vietnam'))
# tallying un-recoded countries to see missing ones
country_counts <- dt5newVars %>%
  filter(is.na(coded_country)) %>%
  group_by(country) %>%
  tally()
```
<br>
<div class="alert alert-warning">
<strong><i class="fa fa-exclamation-triangle"></i> Action needed:</strong> <br> 
We currently have `r length(unique(dt5newVars$country))` different free text country responses. The most recent codes leaves `r sum(country_counts$n[country_counts$country != ""])` responses are still not consolidated.
</div>

### Political Orientation   
Political orientation was measured per language. We merge these variables here.    
```{r PolOr, echo=T, warning=F, message=F}
# clean-up country coding:
rm(country_counts)

# political orientation
dt5newVars <- dt5newVars %>%
  mutate(PolOrX = labelled(rowSums(dplyr::select(., ends_with("_x")), na.rm = T), 
                           labels = NULL, label="Political Compass X-Coordinate"),
         PolOrY = labelled(rowSums(dplyr::select(., ends_with("_y")), na.rm = T), 
                           labels = NULL, label="Political Compass Y-Coordinate"),
         PolOrAuthoritarianLeft = rowSums(dplyr::select(., ends_with("_Authoritarian_Left")), na.rm = T),
         PolOrAuthoritarianLeftLab = dplyr::recode(PolOrAuthoritarianLeft, `1` =  "Authoritarian Left", `0` = ""),
         PolOrAuthoritarianRight = rowSums(dplyr::select(., ends_with("_Authoritarian_right")), na.rm = T),
         PolOrAuthoritarianRightLab = dplyr::recode(PolOrAuthoritarianRight, `1` =  "Authoritarian Right", `0` = ""),
         PolOrLibertarianLeft = rowSums(dplyr::select(., ends_with("_Libertarian_Left")), na.rm = T),
         PolOrLibertarianLeftLab = dplyr::recode(PolOrLibertarianLeft, `1` =  "Libertarian Left", `0` = ""),
         PolOrLibertarianRight = rowSums(dplyr::select(., ends_with("_Libertarian_Right")), na.rm = T),
         PolOrLibertarianRightLab = dplyr::recode(PolOrLibertarianRight, `1` =  "Libertarian Right", `0` = ""),
         PolOrOther = rowSums(dplyr::select(., ends_with("_Other")), na.rm = T),
         PolOrOtherLab = dplyr::recode(PolOrOther, `1` =  "Other", `0` = ""),
         PolOrCat = paste0(PolOrAuthoritarianLeftLab, 
                           PolOrAuthoritarianRightLab,
                           PolOrLibertarianLeftLab,
                           PolOrLibertarianRightLab,
                           PolOrOtherLab), 
         PolOrCat = as.factor(na_if(PolOrCat, ""))) %>%
  dplyr::select(-starts_with("Pol"),
         PolOrX,
         PolOrY,
         PolOrCat)
attr(dt5newVars$PolOrCat,'label') <- 'Political Orientation Quadrant'
```

### Affect    
<!-- TO DO: Write function for item analysis and scale construction -->


#### High Arousal Negative   
```{r affHighNeg, echo=T, results='asis', warning=F, message=F}
# High Arousal Negative
## Anger not measured in wave 1
pairs.panels.new(dt5newVars %>% dplyr::select(affAnx, affNerv))

cat("<br>")

dt5newVars$affHighNeg.m <- scoreItems(keys=c(1,1), items = dt5newVars %>% dplyr::select(affAnx, affNerv), min = 1, max = 5)$scores

as.data.frame(psych::describe(dt5newVars$affHighNeg.m, skew=F)) %>%
  mutate(vars = "High Arousal Negative Affect") %>%
  kable(., caption = "High Arousal Negative Affect: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$affHighNeg.c <- scale(dt5newVars$affHighNeg.m, scale = F, center = T)
dt5newVars$affHighNeg.z <- scale(dt5newVars$affHighNeg.m, scale = T)
dt5newVars$affHighNeg.fa <- fa(dt5newVars %>% dplyr::select(affAnx, affNerv))$scores
```

#### Low Arousal Negative Affect  
```{r affLowNeg, echo=T, results='asis', warning=F, message=F}
# Low Arousal Negative Affect
ia.affLowNeg <- dt5newVars %>%
    dplyr::select(affBor, affExh, affDepr) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.affLowNeg$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.affLowNeg)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(affBor, affExh, affDepr))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Low Arousal Negative Affect: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(affBor, affExh, affDepr))

cat("<br>")

dt5newVars$affLowNeg.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(affBor, affExh, affDepr), min = 1, max = 5)$scores

as.data.frame(psych::describe(dt5newVars$affLowNeg.m, skew=F)) %>%
  mutate(vars = "Low Arousal Negative Affect") %>%
  kable(., caption = "Low Arousal Negative Affect: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$affLowNeg.c <- scale(dt5newVars$affLowNeg.m, scale = F, center = T)
dt5newVars$affLowNeg.z <- scale(dt5newVars$affLowNeg.m, scale = T)
dt5newVars$affLowNeg.fa <- fa(dt5newVars %>% dplyr::select(affBor, affExh, affDepr))$scores
```

#### Low Arousal Positive Affect  
```{r affLowPos, echo=T, results='asis', warning=F, message=F}
# Low Arousal Positive Affect
ia.affLowPos <- dt5newVars %>%
    dplyr::select(affCalm, affContent, affRel) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.affLowPos$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.affLowPos)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(affCalm, affContent, affRel))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Low Arousal Positive Affect: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(affCalm, affContent, affRel))

cat("<br>")

dt5newVars$affLowPos.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(affCalm, affContent, affRel), min = 1, max = 5)$scores

as.data.frame(psych::describe(dt5newVars$affLowPos.m, skew=F)) %>%
  mutate(vars = "Low Arousal Positive Affect") %>%
  kable(., caption = "Low Arousal Positive Affect: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$affLowPos.c <- scale(dt5newVars$affLowPos.m, scale = F, center = T)
dt5newVars$affLowPos.z <- scale(dt5newVars$affLowPos.m, scale = T)
dt5newVars$affLowPos.fa <- fa(dt5newVars %>% dplyr::select(affCalm, affContent, affRel))$scores
```

#### High Arousal Positive Affect  
```{r affHighPos, echo=T, results='asis', warning=F, message=F}
# High Arousal Positive Affect
ia.affHighPos <- dt5newVars %>%
    dplyr::select(affEnerg, affExc, affInsp) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.affHighPos$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.affHighPos)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(affEnerg, affExc, affInsp))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "High Arousal Positive Affect: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(affEnerg, affExc, affInsp))

cat("<br>")

dt5newVars$affHighPos.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(affEnerg, affExc, affInsp), min = 1, max = 5)$scores

as.data.frame(psych::describe(dt5newVars$affHighPos.m, skew=F)) %>%
  mutate(vars = "High Arousal Positive Affect") %>%
  kable(., caption = "High Arousal Positive Affect: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$affHighPos.c <- scale(dt5newVars$affHighPos.m, scale = F, center = T)
dt5newVars$affHighPos.z <- scale(dt5newVars$affHighPos.m, scale = T)
dt5newVars$affHighPos.fa <- fa(dt5newVars %>% dplyr::select(affEnerg, affExc, affInsp))$scores
```

### Loneliness
```{r lone, echo=T, results='asis', warning=F, message=F}
ia.lone<- dt5newVars %>%
    dplyr::select(starts_with("lone")) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.lone$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.lone)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(starts_with("lone")))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Loneliness: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(starts_with("lone")))

cat("<br>")

dt5newVars$lone.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(starts_with("lone")), min = 1, max = 5)$scores

as.data.frame(psych::describe(dt5newVars$lone.m, skew=F)) %>%
  mutate(vars = "Loneliness") %>%
  kable(., caption = "Loneliness: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$lone.c <- scale(dt5newVars$lone.m, scale = F, center = T)
dt5newVars$lone.z <- scale(dt5newVars$lone.m, scale = T)
dt5newVars$lone.fa <- fa(dt5newVars %>% dplyr::select(starts_with("lone")))$scores
```  

### Boredom
```{r bore, echo=T, results='asis', warning=F, message=F}
ia.bor<- dt5newVars %>%
    dplyr::select(starts_with("bor0"), -bor03) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.bor$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.bor)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

pairs.panels.new(dt5newVars %>% dplyr::select(starts_with("bor0"), -bor03))
```
<div class="alert alert-info">
<strong><i class="fa fa-exclamation-triangle"></i> Item dropped:</strong> <br> 
Item three was not well behaved. It seems to measure something else. We dropped it for now.
</div>

```{r bore.red, echo=T, results='asis', warning=F, message=F}

pairs.panels.new(dt5newVars %>% dplyr::select(starts_with("bor0"), -bor03, -bor03_R))

cat("<br>")

dt5newVars$bor.m <- scoreItems(keys=c(1,1), items = dt5newVars %>% dplyr::select(starts_with("bor0"), -bor03, -bor03_R), min = -3, max = 3)$scores

as.data.frame(psych::describe(dt5newVars$bor.m, skew=F)) %>%
  mutate(vars = "Boredom") %>%
  kable(., caption = "Boredom: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$bor.c <- scale(dt5newVars$bor.m, scale = F, center = T)
dt5newVars$bor.z <- scale(dt5newVars$bor.m, scale = T)
dt5newVars$bor.fa <- fa(dt5newVars %>% dplyr::select(starts_with("bor0"), -bor03, -bor03_R))$scores
```
  
### Isolation
```{r iso, echo=T, results='asis', warning=F, message=F}
cat(crayon::bold("Offline Isolation"))
ia.isoPers <- dt5newVars %>%
    dplyr::select(ends_with("inPerson")) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.isoPers$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.isoPers)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(ends_with("inPerson")))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Isolation offline: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(ends_with("inPerson")))

cat("<br>")

dt5newVars$isoPers.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(ends_with("inPerson")), min = 0, max = 7)$scores

as.data.frame(psych::describe(dt5newVars$isoPers.m, skew=F)) %>%
  mutate(vars = "Isolation offline") %>%
  kable(., caption = "Isolation offline: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$isoPers.c <- scale(dt5newVars$isoPers.m, scale = F, center = T)
dt5newVars$isoPers.z <- scale(dt5newVars$isoPers.m, scale = T)
dt5newVars$isoPers.fa <- fa(dt5newVars %>% dplyr::select(ends_with("inPerson")))$scores

cat(crayon::bold("Online Isolation"))
ia.isoOnl <- dt5newVars %>%
    dplyr::select(ends_with("online")) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.isoOnl$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.isoOnl)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(ends_with("inPerson")))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Isolation online: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(ends_with("online")))

cat("<br>")

dt5newVars$isoOnl.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(ends_with("online")), min = 0, max = 7)$scores

as.data.frame(psych::describe(dt5newVars$isoPers.m, skew=F)) %>%
  mutate(vars = "Isolation online") %>%
  kable(., caption = "Isolation online: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$isoOnl.c <- scale(dt5newVars$isoOnl.m, scale = F, center = T)
dt5newVars$isoOnl.z <- scale(dt5newVars$isoOnl.m, scale = T)
dt5newVars$isoOnl.fa <- fa(dt5newVars %>% dplyr::select(ends_with("online")))$scores

# Leave House
as.data.frame(psych::describe(dt5newVars$houseLeave, skew=F)) %>%
  mutate(vars = "Leaving House") %>%
  kable(., caption = "Leaving House: Item Descriptive", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")
```

### Government Response
No responses yet
```{r gov, echo=T, results='asis', warning=F, message=F}
# extC19Msg
```

### Community Response
```{r community, echo=T, results='asis', warning=F, message=F}
ia.ext <- dt5newVars %>%
    dplyr::select(starts_with("extC19"), -extC19Msg) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.ext$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.ext)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(starts_with("extC19"), -extC19Msg))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Community response: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(starts_with("extC19"), -extC19Msg))

cat("<br>")

dt5newVars$ext.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(starts_with("extC19"), -extC19Msg), 
                             min = 1, max = 6)$scores

as.data.frame(psych::describe(dt5newVars$ext.m, skew=F)) %>%
  mutate(vars = "Community response") %>%
  kable(., caption = "Community response: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$ext.c <- scale(dt5newVars$ext.m, scale = F, center = T)
dt5newVars$ext.z <- scale(dt5newVars$ext.m, scale = T)
dt5newVars$ext.fa <- fa(dt5newVars %>% dplyr::select(starts_with("extC19"), -extC19Msg))$scores
```

### Behavioral Response
```{r beh, echo=T, results='asis', warning=F, message=F}
ia.beh <- dt5newVars %>%
    dplyr::select(starts_with("c19per")) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.beh$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.beh)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(starts_with("c19per")))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Behavioral response: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(starts_with("c19per")))

cat("<br>")

dt5newVars$beh.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(starts_with("c19per")), 
                             min = -3, max = 3)$scores

as.data.frame(psych::describe(dt5newVars$beh.m, skew=F)) %>%
  mutate(vars = "Behavioral response") %>%
  kable(., caption = "Behavioral response: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$beh.c <- scale(dt5newVars$beh.m, scale = F, center = T)
dt5newVars$beh.z <- scale(dt5newVars$beh.m, scale = T)
dt5newVars$beh.fa <- fa(dt5newVars %>% dplyr::select(starts_with("c19per")))$scores
```

### Hope and Efficacy
```{r hopeEff, echo=T, results='asis', warning=F, message=F}
as.data.frame(psych::describe(dt5newVars$c19Hope)) %>%
  mutate(vars = "Hope") %>%
  kable(., caption = "Hope: Item Descriptive", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

ggplot(dt5newVars, aes(x = c19Hope)) +
  geom_histogram(binwidth=1, alpha=0.5) +
  #geom_density(alpha=0.6)+
  labs(title="Hope distribution",x="Corona Virus Hope", y = "Frequency") +
  theme_Publication()
  
as.data.frame(psych::describe(dt5newVars$c19Eff)) %>%
  mutate(vars = "Efficacy") %>%
  kable(., caption = "Efficacy: Item Descriptive", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

ggplot(dt5newVars, aes(x = c19Eff)) +
  geom_histogram(binwidth=1, alpha=0.5) +
  #geom_density(alpha=0.6)+
  labs(title="Efficacy distribution",x="Corona Virus Efficacy", y = "Frequency") +
  theme_Publication()
```

### State Paranoia
```{r para, echo=T, results='asis', warning=F, message=F}
ia.para <- dt5newVars %>%
    dplyr::select(starts_with("para")) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.para$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.para)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(starts_with("para")))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "State Paranoia: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(starts_with("para")))

cat("<br>")

dt5newVars$para.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(starts_with("para")), 
                             min = 0, max = 10)$scores

as.data.frame(psych::describe(dt5newVars$para.m, skew=F)) %>%
  mutate(vars = "State Paranoia") %>%
  kable(., caption = "State Paranoia: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$para.c <- scale(dt5newVars$para.m, scale = F, center = T)
dt5newVars$para.z <- scale(dt5newVars$para.m, scale = T)
dt5newVars$para.fa <- fa(dt5newVars %>% dplyr::select(starts_with("para")))$scores
```

### Conspiracy Theory
```{r consp, echo=T, results='asis', warning=F, message=F}
ia.consp <- dt5newVars %>%
    dplyr::select(starts_with("consp")) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.consp$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.consp)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(starts_with("consp")))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Conspiracy Theory: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(starts_with("consp")))

cat("<br>")

dt5newVars$consp.m <- scoreItems(keys=c(1,1,1), items = dt5newVars %>% dplyr::select(starts_with("consp")), 
                             min = 0, max = 10)$scores

as.data.frame(psych::describe(dt5newVars$consp.m, skew=F)) %>%
  mutate(vars = "Conspiracy Theory") %>%
  kable(., caption = "Conspiracy Theory: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$para.c <- scale(dt5newVars$consp.m, scale = F, center = T)
dt5newVars$para.z <- scale(dt5newVars$consp.m, scale = T)
dt5newVars$para.fa <- fa(dt5newVars %>% dplyr::select(starts_with("consp")))$scores
```

### Job Insecurity
```{r jbinsc, echo=T, results='asis', warning=F, message=F}
ia.jobinsec<- dt5newVars %>%
    dplyr::select(starts_with("jbInsec"), -jbInsec02, -jbInsec04) %>%
    na_if(., -99) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.jobinsec$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.jobinsec)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(starts_with("jbInsec"), -jbInsec02, -jbInsec04) %>% na_if(., -99))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Job insecurity: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(starts_with("jbInsec"), -jbInsec02, -jbInsec04) %>% na_if(., -99))

cat("<br>")

dt5newVars$jobinsec.m <- scoreItems(keys=c(1,1,1), 
                                  items = dt5newVars %>% dplyr::select(starts_with("jbInsec"), -jbInsec02, -jbInsec04) %>% na_if(., -99),
                                  min = -2, max = 2)$scores

as.data.frame(psych::describe(dt5newVars$jobinsec.m, skew=F)) %>%
  mutate(vars = "Job insecurity") %>%
  kable(., caption = "Job insecurity: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$jobinsec.c <- scale(dt5newVars$jobinsec.m, scale = F, center = T)
dt5newVars$jobinsec.z <- scale(dt5newVars$jobinsec.m, scale = T)
dt5newVars$jobinsec.fa <- fa(dt5newVars %>% dplyr::select(starts_with("jbInsec"), -jbInsec02, -jbInsec04))$scores
```

### Financial Strain
```{r finance, echo=T, results='asis', warning=F, message=F}
ia.pfs<- dt5newVars %>%
    dplyr::select(starts_with("PFS0")) %>%
    Scale::Scale() %>%
    Scale::ItemAnalysis()
ia.pfs$rely   
cat("<br><br>A gls factor analysis was conducted. Items were regressed to a single factor. Their loadings are the following:")
as.data.frame(Scale::ReportTable(ia.pfs)) %>%
  kable(., row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

as.data.frame(psych::describe(dt5newVars %>% dplyr::select(starts_with("PFS0")))) %>%
  mutate(vars = rownames(.)) %>%
  kable(., caption = "Financial Strain: Item Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

cat("<br>")

pairs.panels.new(dt5newVars %>% dplyr::select(starts_with("PFS0")))

cat("<br>")

dt5newVars$pfs.m <- scoreItems(keys=c(1,1,1), 
                                  items = dt5newVars %>% dplyr::select(starts_with("PFS0")),
                                  min = -2, max = 2)$scores

as.data.frame(psych::describe(dt5newVars$pfs.m, skew=F)) %>%
  mutate(vars = "inancial Strain") %>%
  kable(., caption = "inancial Strain: Scale Descriptives", row.names = FALSE) %>% 
  kable_styling("hover", full_width = F, latex_options = "hold_position")

dt5newVars$pfs.c <- scale(dt5newVars$pfs.m, scale = F, center = T)
dt5newVars$pfs.z <- scale(dt5newVars$pfs.m, scale = T)
dt5newVars$pfs.fa <- fa(dt5newVars %>% dplyr::select(starts_with("PFS0")))$scores
```


## **Reduce to Relevant Variales**   
```{r keyVars, echo=T, warning=F, message=F}
# clean-up Item Analyses
rm(list=ls(pattern="ia"))

# remove directly identifiable data (with and without page timers)
dt6ReducedTimer <- dt5newVars %>%
  dplyr::select(-c(IPAddress, 
            RecipientLastName, 
            RecipientFirstName, 
            RecipientEmail, 
            ExternalReference, 
            LocationLatitude, 
            LocationLongitude,
            DistributionChannel,
            ICRec_1_TEXT))
dt6Reduced <- dt6ReducedTimer %>%
  dplyr::select(-starts_with("t_"))

# remove filtered cases (with and without page timers)
dt6ReducedTimerCases <- dt6ReducedTimer %>%
  filter(FilterPreview == 0,
         FilterTime == 0,
         FilterStraightliner == 0) %>%
  dplyr::select(-starts_with("Filter"))
dt6ReducedCases <- dt6Reduced %>%
  filter(FilterPreview == 0,
         FilterTime == 0,
         FilterStraightliner == 0) %>%
  dplyr::select(-starts_with("Filter"))
```

## **Export**   
Export main dataframe as RData and SPSS sav files. We export versions with and without page timers
```{r export, echo=T, warning=F, message=F}
namSPSS <- paste0("data/cleaned data/Psycorona Baseline cleaned ", format(Sys.time(), format = "%F %H-%M %Z"),".sav")
namR <- paste0("data/cleaned data/Psycorona Baseline cleaned ", format(Sys.time(), format = "%F %H-%M %Z"),".RData")
namTSPSS <- paste0("data/cleaned data/Psycorona Baseline cleaned with page timer ", format(Sys.time(), format = "%F %H-%M %Z"),".sav")
namTR <- paste0("data/cleaned data/Psycorona Baseline cleaned with page timer ", format(Sys.time(), format = "%F %H-%M %Z"),".RData")
write_sav(dt6Reduced, namSPSS)
write_sav(dt6ReducedTimer, namTSPSS)
save(dt6Reduced, file = namR)
save(dt6ReducedTimer, file = namTR)
rm(list=ls(pattern="nam"))

# export for Shiny
saveRDS(dt6ReducedCases, file = "../PsyCorona-WebApp/data/reducedData.rds")
```
